WebGLUtils=function(){var e=function(e){return'<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+e+"</div></div></td></tr></table>"},t='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',r='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>',i=function(e,t){for(var r=["webgl","experimental-webgl","webkit-3d","moz-webgl"],i=null,a=0;a<r.length;++a){try{i=e.getContext(r[a],t)}catch(e){}if(i)break}return i};return{create3DContext:i,setupWebGL:function(a,o,n){n=n||function(i){var o=a.parentNode;if(o){var n=window.WebGLRenderingContext?r:t;i&&(n+="<br/><br/>Status: "+i),o.innerHTML=e(n)}},a.addEventListener&&a.addEventListener("webglcontextcreationerror",function(e){n(e.statusMessage)},!1);var l=i(a,o);return l||window.WebGLRenderingContext||n(""),l}}}(),window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)};class Player{constructor(e,t,r,i,a,o,n,l,s){this.id=e,this.startLocation=[...t],this.location=[...t],this.range=o,this.width=20,this.height=100,this.color=i,this.nickname=a,this.velocity=10,this.direction90Vector=vec2.rotate(vec3.fromValues(0,0,0),[0,1],[0,0],r),this.direction=directions.PAUSE,this.angle=r,this.drawingMode=gl.TRIANGLE_STRIP,this.score=n,this.isHost=l,this.isAlive=s,this.lastUpdate=(new Date).getTime(),this.mvMatrix=mat4.create(),mat4.identity(this.mvMatrix),mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip(Object.create(t))),this.computeVertices=(()=>[...rotated([-this.width/2,this.height/2],r),...rotated([this.width/2,this.height/2],r),...rotated([-this.width/2,-this.height/2],r),...rotated([this.width/2,-this.height/2],r)]),this.move=(()=>{const e=(new Date).getTime();if(0!==this.direction){const t=vec3.scale(vec3.create(),this.direction90Vector,.08*(e-this.lastUpdate)*this.velocity*this.direction);mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip(t)),vec3.add(this.location,this.location,t)}this.lastUpdate=e}),this.translateTo=(e=>{mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip([e[0]-this.location[0],e[1]-this.location[1],0])),this.location=[...e],this.lastUpdate=(new Date).getTime()})}}const rotated=(e,t)=>vec2.rotate(vec2.create(),e,[0,0],t),directions={PAUSE:0,FORWARD:1,BACKWARD:-1};class Ball{constructor(e,t){this.location=Object.create(e),this.radius=10,this.velocity=[0,0,0],this.mvMatrix=mat4.create(),this.color=t,this.drawingMode=gl.TRIANGLE_FAN,this.lastUpdate=(new Date).getTime(),mat4.identity(this.mvMatrix),mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip(Object.create(e))),this.computeVertices=(()=>{const e=[0,0];for(let t=0;t<=100;t++)e.push(Math.cos(2*t*Math.PI/100)*this.radius),e.push(Math.sin(2*t*Math.PI/100)*this.radius);return e}),this.move=(()=>{const e=(new Date).getTime(),t=vec3.scale(vec3.create(),this.velocity,.08*(e-this.lastUpdate));mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip(t)),vec3.add(this.location,this.location,t),this.lastUpdate=e}),this.translateTo=(e=>{mat4.translate(this.mvMatrix,this.mvMatrix,normalToClip([e[0]-this.location[0],e[1]-this.location[1],0])),this.location=[...e],this.lastUpdate=(new Date).getTime()})}}const handleKeyDown=(e,t,r)=>{const i=e[t];null!=i&&("ArrowUp"===r.code&&i.direction!==directions.BACKWARD||"ArrowDown"===r.code&&i.direction!==directions.FORWARD)&&(i.direction=(r.ctrlKey||r.metaKey?3:1)*("ArrowUp"===r.code?directions.BACKWARD:directions.FORWARD),wsEmitMove(i,i.direction))},handleKeyUp=(e,t,r)=>{const i=e[t];null!=i&&("ArrowUp"!==r.code&&"ArrowDown"!==r.code||(i.direction=directions.PAUSE,wsEmitMove(i,i.direction)))},initKeyBinding=(e,t)=>{document.onkeydown=(r=>handleKeyDown(e,t,r)),document.onkeyup=(r=>handleKeyUp(e,t,r))},ACCELERATION=1.1,ELIMINATION_DISTANCE=20,handleBallWithPlayerCollision=(e,t,r)=>{const i=vec3.fromValues(0,0,0),a=vec2.subtract(vec3.create(),t.location,e.location);if(vec2.rotate(a,a,[0,0],-e.angle),Math.abs(a[0]-i[0])<=t.radius+e.width/2&&(a[0]-i[0])*r>=0&&Math.abs(a[1]-i[1])<=t.radius+e.height/2){const i=e.direction90Vector,o=vec2.create();vec2.rotate(o,i,[0,0],Math.PI/2);const n=vec2.dot(t.velocity,i),l=vec3.fromValues(0,0,0);vec2.scale(l,i,n);const s=vec2.dot(t.velocity,o),c=vec2.scale(vec3.fromValues(0,0,0),o,-s);vec3.add(t.velocity,l,c),vec3.scale(t.velocity,t.velocity,1.1);const d=vec2.rotate(vec3.fromValues(0,0,0),[(t.radius+e.width/2)*r,a[1],0],[0,0],e.angle);t.translateTo([e.location[0]+d[0],e.location[1]+d[1]])}},handleElimination=(e,t,r)=>{const i=vec3.fromValues(0,0,0),a=vec2.subtract(vec3.create(),t.location,e.location);vec2.rotate(a,a,[0,0],-e.angle),a[0]-t.radius<=i[0]-20&&(console.log("kick player "+e.nickname+"("+e.id+")"),r(e.id))},handleBallWithCanvasCollision=()=>{(ball.location[1]-ball.radius<0||ball.location[1]+ball.radius>=canvas.height)&&(vec3.multiply(ball.velocity,ball.velocity,[1,-1,1]),vec3.scale(ball.velocity,ball.velocity,1.1)),(ball.location[0]-ball.radius<0||ball.location[0]+ball.radius>=canvas.height)&&(vec3.multiply(ball.velocity,ball.velocity,[-1,1,1]),vec3.scale(ball.velocity,ball.velocity,1.1))},handlePlayerRange=(e,t)=>{const r=vec3.subtract(vec3.create(),t.location,t.startLocation);if(vec2.rotate(r,r,[0,0],-t.angle),r[1]>t.range/2||r[1]<-t.range/2){r[1]=t.range/2*(r[1]<-t.range/2?-1:1);const e=vec2.rotate(vec3.create(),r,[0,0],t.angle);t.translateTo([t.startLocation[0]+e[0],t.startLocation[1]+e[1]])}},handleCollision=(e,t,r,i)=>{for(let e of Object.values(t))handlePlayerRange(0,e),handleBallWithPlayerCollision(e,r,1),handleBallWithPlayerCollision(e,r,-1),handleElimination(e,r,i);handleBallWithCanvasCollision()};let shaderProgram,resolution;const initGL=e=>{let t;try{(t=e.getContext("webgl")).viewportWidth=e.width,t.viewportHeight=e.height,resolution=[e.width,e.height,1]}catch(e){}return t||console.log("Could not initialize WebGL."),t},vertexShaderSource="\n  uniform vec2 uResolution;\n  attribute vec2 aVertexPosition;\n  attribute vec4 aVertexColor;\n\n  uniform mat4 uMVMatrix;\n\n  varying vec4 vColor;\n\n  void main(void) {\n    // Convert the rectangle from pixels to 0.0 to 1.0\n    vec2 zeroToOne = aVertexPosition / uResolution;\n    // Convert from 0->1 to 0->2\n    vec2 zeroToTwo = zeroToOne * 2.0;\n    // Convert from 0->2 to -1->+1 (clipspace)\n    vec2 clipSpace = zeroToTwo - 1.0;\n    gl_Position = vec4(clipSpace * vec2(1, -1), 0.0, 1.0);\n    gl_Position = uMVMatrix * vec4(clipSpace * vec2(1, -1), 0.0, 1.0);\n    vColor = aVertexColor;\n  }\n",fragmentShaderSource="\n   precision mediump float;\n\n   varying vec4 vColor;\n\n   void main(void) {\n    gl_FragColor = vColor;\n   }\n  ";function loadShader(e,t,r){const i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(alert("An error occurred compiling the shaders: "+e.getShaderInfoLog(i)),e.deleteShader(i),null)}const initShaders=e=>{const t=loadShader(e,e.VERTEX_SHADER,vertexShaderSource),r=loadShader(e,e.FRAGMENT_SHADER,fragmentShaderSource);shaderProgram=e.createProgram(),e.attachShader(shaderProgram,t),e.attachShader(shaderProgram,r),e.linkProgram(shaderProgram),e.getProgramParameter(shaderProgram,e.LINK_STATUS)||alert("Could not initialize shaders"),e.useProgram(shaderProgram),shaderProgram.resolutionUniform=e.getUniformLocation(shaderProgram,"uResolution"),shaderProgram.vertexPositionAttribute=e.getAttribLocation(shaderProgram,"aVertexPosition"),e.enableVertexAttribArray(shaderProgram.vertexPositionAttribute),shaderProgram.vertexColorAttribute=e.getAttribLocation(shaderProgram,"aVertexColor"),e.enableVertexAttribArray(shaderProgram.vertexColorAttribute),shaderProgram.mvMatrixUniform=e.getUniformLocation(shaderProgram,"uMVMatrix")},drawingMVMatrices=[],drawingVertexBuffers=[],drawingColorBuffers=[],drawingMode=[],initBuffers=e=>{e.vertexBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,e.vertexBuffer);const t=e.computeVertices();gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t),gl.STATIC_DRAW),e.vertexBuffer.itemSize=2,e.vertexBuffer.numItems=t.length/2,e.colors=[];for(let r=0;r<t.length/2;r++)e.colors=e.colors.concat(e.color);e.colorBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,e.colorBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e.colors),gl.STATIC_DRAW),e.colorBuffer.itemSize=4,e.colorBuffer.numItems=t.length/2,drawingMVMatrices.push(e.mvMatrix),drawingVertexBuffers.push(e.vertexBuffer),drawingColorBuffers.push(e.colorBuffer),drawingMode.push(e.drawingMode)},refillBuffers=e=>{drawingMVMatrices.push(e.mvMatrix),drawingVertexBuffers.push(e.vertexBuffer),drawingColorBuffers.push(e.colorBuffer),drawingMode.push(e.drawingMode)},setMatrixUniforms=e=>{gl.uniform2f(shaderProgram.resolutionUniform,canvas.width,canvas.height),gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,e)},drawScene=()=>{let e,t,r;gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);for(let i=drawingVertexBuffers.length;i>0;i--){let i=drawingMVMatrices.pop();e=drawingVertexBuffers.pop(),t=drawingColorBuffers.pop(),r=drawingMode.pop(),gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute,e.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.vertexAttribPointer(shaderProgram.vertexColorAttribute,t.itemSize,gl.FLOAT,!1,0,0),setMatrixUniforms(i),gl.drawArrays(r,0,r===gl.TRIANGLE_FAN?101:4)}},wsEmitMove=(e,t)=>{socket.emit("player-location",{id:e.id,location:e.location,direction:t})},wsEmitBallLocation=e=>{socket.emit("ball-location",{location:e.location,velocity:e.velocity,mvMatrix:e.mvMatrix})},wsEmitElimination=(e,t)=>{socket.emit("elimination",{id:e,roundId:t})},wsEmitNewGame=()=>{socket.emit("new-game",{})},wsEmitJoin=e=>{socket.emit("join",{id:currentPlayerId,nickname:e})};function displayCountDown(){for(let e=5;e>=0;e--)setTimeout(()=>overlay.innerHTML=0===e?"GO!":e,2500-500*e);setTimeout(()=>overlay.innerHTML="",3e3)}const initWebSocketHandlers=(e,t,r,i)=>{const a=e=>{const t=new Player(e.id,e.location,e.angle,e.color,e.nickname,e.range,e.score,e.isHost,e.isAlive);return r(t),t};socket.on("players-sync",r=>{for(let i of Object.values(r))null==e[i.id]&&(e[i.id]=a(i)),i.id!==t&&(e[i.id].translateTo([...i.location]),e[i.id].direction=i.direction),e[i.id].score=i.score;const o=Object.values(r).map(e=>e.id);Object.keys(e).filter(e=>!o.includes(e)).forEach(t=>delete e[t]),i(e)}),socket.on("new-round",t=>{roundId=t.roundId,ball.translateTo(Object.values(t.ball.location)),ball.velocity=[0,0,0];for(let r of t.players)e[r.id]=a(r),console.log("new-round init buffer");displayCountDown(),setTimeout(()=>{ball.velocity=t.ball.velocity},2500)}),socket.on("ball-sync",e=>{ball.velocity=e.velocity,ball.location=e.location,ball.mvMatrix=mat4.fromValues(...Object.values(e.mvMatrix))})},{mat4:mat4,vec3:vec3,vec2:vec2}=glMatrix,WHITE=[1,1,1,1];let gl,canvas,overlay;const players={};let ball,currentPlayerId,roundId=null;const initBall=()=>{ball=new Ball([400,400,0],WHITE),initBuffers(ball)},normalToClip=e=>{const t=vec3.divide(vec3.create(),e,resolution),r=vec3.multiply(vec3.create(),t,[2,2,2]);return vec3.multiply(r,r,[1,-1,0])},playerEliminated=e=>{overlay.innerHTML=`${players[e].nickname} has been eliminated`,ball.velocity=[0,0,0],setTimeout(()=>{overlay.innerHTML=""},1e3),wsEmitElimination(e,roundId)},handlePlayersMovement=e=>{for(let t of Object.values(e))t.move()},tick=()=>{requestAnimFrame(tick),handlePlayersMovement(players),handleCollision(0,players,ball,playerEliminated),drawScene(),ball.move(),animate(players,ball)},animate=(e,t)=>{for(let t of Object.values(e))t.isAlive&&refillBuffers(t);refillBuffers(t)},loadGame=()=>{canvas=document.getElementById("canvas"),overlay=document.getElementById("overlay"),gl=initGL(canvas),initShaders(gl),ball=new Ball([400,400,0],WHITE),initBuffers(ball),initKeyBinding(players,currentPlayerId),initWebSocketHandlers(players,currentPlayerId,initBuffers,printScore),gl.clearColor(.1875,.1875,.1875,1),gl.enable(gl.DEPTH_TEST),setInterval(()=>{null!=players[currentPlayerId]&&players[currentPlayerId].isHost},500),tick(),printScore(players)},printScore=e=>{document.getElementById("score").innerHTML=Object.values(e).map(e=>`player ${e.nickname}: ${e.score}`).join(", ")},newGame=()=>{socket.emit("new-game",{})},joinGame=()=>{const e=document.getElementById("nickname").value;null!=e&&wsEmitJoin(e)},connect=()=>{socket.on("connect",()=>{currentPlayerId=socket.id.split("#")[1],canvas=document.getElementById("canvas"),overlay=document.getElementById("overlay"),gl=initGL(canvas),initShaders(gl),ball=new Ball([400,400,0],WHITE),initBuffers(ball),initKeyBinding(players,currentPlayerId),initWebSocketHandlers(players,currentPlayerId,initBuffers,printScore),gl.clearColor(.1875,.1875,.1875,1),gl.enable(gl.DEPTH_TEST),setInterval(()=>{null!=players[currentPlayerId]&&players[currentPlayerId].isHost},500),tick(),printScore(players)})};socket.on("connect",()=>{currentPlayerId=socket.id.split("#")[1],canvas=document.getElementById("canvas"),overlay=document.getElementById("overlay"),gl=initGL(canvas),initShaders(gl),ball=new Ball([400,400,0],WHITE),initBuffers(ball),initKeyBinding(players,currentPlayerId),initWebSocketHandlers(players,currentPlayerId,initBuffers,printScore),gl.clearColor(.1875,.1875,.1875,1),gl.enable(gl.DEPTH_TEST),setInterval(()=>{null!=players[currentPlayerId]&&players[currentPlayerId].isHost},500),tick(),printScore(players)}),document.getElementById("newGameButton").onclick=newGame,document.getElementById("joinGameButton").onclick=joinGame;